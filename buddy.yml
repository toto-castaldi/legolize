- pipeline: "Deploy"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "http://legolize.skillbill.net"
  actions:
  - action: "[API] Build Docker image"
    type: "DOCKERFILE"
    login: "${DOCKER_HUB_USER}"
    password: "${DOCKER_HUB_PASSWORD}"
    docker_image_tag: "latest"
    dockerfile_path: "application/Dockerfile-api"
    context_path: "application/"
    repository: "skillbillsrl/legolize-api"
    build_args:
    - "version=${BUDDY_EXECUTION_REVISION}"
    trigger_condition_paths:
    - "/application"
    trigger_condition: "ON_CHANGE_AT_PATH"
  - action: "[ENGINE] Build Docker image"
    type: "DOCKERFILE"
    login: "${DOCKER_HUB_USER}"
    password: "${DOCKER_HUB_PASSWORD}"
    docker_image_tag: "latest"
    dockerfile_path: "application/Dockerfile-engine"
    context_path: "application/"
    repository: "skillbillsrl/legolize-engine"
    build_args:
    - "version=${BUDDY_EXECUTION_REVISION}"
    trigger_condition_paths:
    - "/application"
    trigger_condition: "ON_CHANGE_AT_PATH"
  - action: "[FE] Build Docker image"
    type: "DOCKERFILE"
    login: "${DOCKER_HUB_USER}"
    password: "${DOCKER_HUB_PASSWORD}"
    docker_image_tag: "latest"
    dockerfile_path: "fe/Dockerfile"
    context_path: "fe/"
    repository: "skillbillsrl/legolize-fe"
    build_args:
    - "version=${BUDDY_EXECUTION_REVISION}"
    trigger_condition_paths:
    - "/fe"
    trigger_condition: "ON_CHANGE_AT_PATH"
  - action: "update docker-compose"
    type: "SFTP"
    input_type: "SCM_REPOSITORY"
    local_path: "docker-compose.yml"
    remote_path: "${WORKDIR}"
    login: "root"
    host: "${SERVER_NAME}"
    port: "22"
    env_key: "prod_rsa"
    authentication_mode: "ENV_KEY"
  - action: "docker-compose restart"
    type: "SSH_COMMAND"
    working_directory: "${WORKDIR}"
    login: "root"
    host: "${SERVER_NAME}"
    port: "22"
    env_key: "prod_rsa"
    authentication_mode: "ENV_KEY"
    commands:
    - "set -e"
    - "echo \"$DOCKER_HUB_PASSWORD\" | \\"
    - "\tdocker login -u \"$DOCKER_HUB_USER\" --password-stdin"
    - "trap 'docker logout' 0"
    - "export TAG=latest"
    - "docker-compose pull"
    - "docker-compose down --remove-orphans"
    - "docker-compose up -d"
    - "docker image prune -a"
    - "docker volume prune"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"